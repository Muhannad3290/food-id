<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Speed Ramadan Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #222; color: white; margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; background: #333; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        h2 { margin-top: 0; color: #fff; }
        
        /* Scanner Viewfinder */
        #reader { width: 100%; border-radius: 10px; overflow: hidden; border: 3px solid #555; background: black; }
        
        /* Big, clear status boxes for fast moving lines */
        #status-box { margin-top: 15px; padding: 20px; font-size: 22px; font-weight: bold; border-radius: 8px; display: none; }
        .success { background-color: #28a745; color: white; border: 3px solid #1e7e34; }
        .error { background-color: #dc3545; color: white; border: 3px solid #b02a37; }
        
        #stats { margin-top: 20px; font-size: 18px; font-weight: bold; color: #aaa; }
        #meal-count { color: #28a745; font-size: 24px; }
        
        .btn-start { width: 100%; padding: 15px; font-size: 20px; font-weight: bold; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>⚡ Fast Scan (Back of ID)</h2>
    
    <button id="start-btn" class="btn-start" onclick="startFastScanner()">Start Live Scanner</button>

    <div id="reader"></div>

    <div id="status-box"></div>
    
    <div id="stats">Meals Given Today: <span id="meal-count">0</span></div>
</div>

<script>
    let isProcessing = false; // Prevents double-scanning the same card in 1 second

    // 1. Start the High-Speed Scanner
    function startFastScanner() {
        document.getElementById('start-btn').style.display = 'none';

        const html5QrCode = new Html5Qrcode("reader");
        
        // Configuration: scans 10 times a second
        const config = { fps: 10, qrbox: { width: 300, height: 150 } };

        // Start scanning the back camera
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            alert("Camera error. Make sure you are using HTTPS.");
            console.error(err);
        });
    }

    // 2. Triggered instantly when a barcode is found
    function onScanSuccess(decodedText) {
        if (isProcessing) return; // Ignore if we are currently showing a result
        
        isProcessing = true; // Lock the scanner briefly

        // Sometimes the barcode has extra data. Let's pull out just the 15 digit ID.
        // It looks for 784 followed by numbers and hyphens.
        let extractedID = decodedText;
        const idMatch = decodedText.match(/(784[0-9\-]{12,14})/);
        if (idMatch) {
            extractedID = idMatch[0].replace(/-/g, ''); // Remove hyphens so it's a clean 15-digit number
        }

        processID(extractedID);

        // Wait 2.5 seconds before allowing the next scan (gives volunteer time to hand over food)
        setTimeout(() => {
            isProcessing = false;
            document.getElementById("status-box").style.display = "none";
        }, 2500);
    }

    // 3. Database Logic (Instant LocalStorage check)
    function processID(idNumber) {
        let statusBox = document.getElementById("status-box");
        let today = new Date().toISOString().split('T')[0]; 
        let records = JSON.parse(localStorage.getItem(`meals_${today}`)) || {};

        statusBox.style.display = "block";

        if (records[idNumber]) {
            // Already eaten!
            statusBox.className = "error";
            statusBox.innerHTML = `❌ ALREADY SERVED!<br><span style="font-size:16px;">ID: ${idNumber}</span>`;
            playBeep(false);
        } else {
            // New person!
            records[idNumber] = new Date().toLocaleTimeString(); 
            localStorage.setItem(`meals_${today}`, JSON.stringify(records));
            
            statusBox.className = "success";
            statusBox.innerHTML = `✅ APPROVED!<br><span style="font-size:16px;">ID: ${idNumber}</span>`;
            playBeep(true);
        }
        
        updateStats();
    }

    function updateStats() {
        let today = new Date().toISOString().split('T')[0];
        let records = JSON.parse(localStorage.getItem(`meals_${today}`)) || {};
        document.getElementById("meal-count").innerText = Object.keys(records).length;
    }

    // Audio Feedback (Crucial for fast lines so you don't have to look at the screen)
    function playBeep(isSuccess) {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.connect(ctx.destination);
            osc.frequency.value = isSuccess ? 1000 : 150; // High beep for success, low buzz for error
            osc.type = isSuccess ? 'sine' : 'sawtooth';
            osc.start();
            setTimeout(() => osc.stop(), isSuccess ? 200 : 500);
        } catch(e) {}
    }

    // Load stats on startup
    window.onload = updateStats;
</script>

</body>
</html>
